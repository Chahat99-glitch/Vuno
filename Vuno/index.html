<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vuno - Offline Music Player</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/heroicons@2.1.3/24/outline/index.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/heroicons@2.1.3/24/solid/index.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Righteous&display=swap" rel="stylesheet">


    <style>
        /* Custom Neumorphism Styles - Enhanced with Dark Mode */
        :root {
            /* Light Mode Variables */
            --bg-color: #e0e5ec;
            --light-shadow: #ffffff;
            --dark-shadow: #a3b1c6;
            --text-color: #4a5568;
            --text-color-light: #718096;
            --accent-color: #6d5dfc;
            --accent-color-darker: #5a4ccd;
            --neumorph-outset-shadow: 8px 8px 15px var(--dark-shadow), -8px -8px 15px var(--light-shadow);
            --neumorph-inset-shadow: inset 7px 7px 14px var(--dark-shadow), inset -7px -7px 14px var(--light-shadow);
            --neumorph-button-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
            --neumorph-button-shadow-hover: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);
            --neumorph-button-shadow-active: inset 5px 5px 10px var(--dark-shadow), inset -5px -5px 10px var(--light-shadow);
             --range-thumb-shadow: 3px 3px 6px rgba(0,0,0,0.2), -3px -3px 6px rgba(255,255,255,0.7);
             --range-thumb-shadow-active: inset 1px 1px 2px rgba(0,0,0,0.3), inset -1px -1px 2px rgba(255,255,255,0.8);
        }

        html.dark {
             /* Dark Mode Variables */
            --bg-color: #2c303a; /* Dark background */
            --light-shadow: #3a3f4c; /* Lighter dark shadow */
            --dark-shadow: #1e2128; /* Very dark shadow */
            --text-color: #c1c8d4; /* Lighter text */
            --text-color-light: #8a99ae;
            --accent-color: #7f70fc; /* Slightly brighter accent */
            --accent-color-darker: #6d5dfc;
             /* Re-define shadows for dark mode */
             --neumorph-outset-shadow: 8px 8px 15px var(--dark-shadow), -8px -8px 15px var(--light-shadow);
             --neumorph-inset-shadow: inset 7px 7px 14px var(--dark-shadow), inset -7px -7px 14px var(--light-shadow);
             --neumorph-button-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
             --neumorph-button-shadow-hover: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);
             --neumorph-button-shadow-active: inset 5px 5px 10px var(--dark-shadow), inset -5px -5px 10px var(--light-shadow);
             --range-thumb-shadow: 3px 3px 6px rgba(0,0,0,0.4), -2px -2px 4px rgba(60, 60, 70, 0.7); /* Adjusted for dark bg */
             --range-thumb-shadow-active: inset 1px 1px 2px rgba(0,0,0,0.5), inset -1px -1px 2px rgba(70, 70, 80, 0.8);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .vuno-title {
            font-family: 'Righteous', cursive;
            color: var(--text-color); /* Use variable */
            transition: color 0.3s ease;
        }
        html.dark .vuno-title {
             color: var(--text-color); /* Ensure it uses the dark mode text color */
        }

        .neumorph-outset {
            border-radius: 20px;
            background: var(--bg-color);
            box-shadow: var(--neumorph-outset-shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .neumorph-inset {
            border-radius: 20px;
            background: var(--bg-color);
            box-shadow: var(--neumorph-inset-shadow);
             transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

         .neumorph-card-hover:hover {
             /* Consistent hover shadow */
             box-shadow: 10px 10px 20px var(--dark-shadow), -10px -10px 20px var(--light-shadow);
         }

        .neumorph-button {
            border-radius: 12px;
            background: var(--bg-color);
            box-shadow: var(--neumorph-button-shadow);
            transition: all 0.15s ease-in-out;
            color: var(--text-color-light); /* Lighter color for icons initially */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .neumorph-button:not(:disabled):hover {
             color: var(--accent-color);
             box-shadow: var(--neumorph-button-shadow-hover);
        }
        .neumorph-button:active:not(:disabled), .neumorph-button.active:not(:disabled) {
            box-shadow: var(--neumorph-button-shadow-active);
            color: var(--accent-color-darker);
            transform: translateY(1px);
        }
         .neumorph-button.disabled, .neumorph-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            /* Keep inset shadow for disabled look */
            box-shadow: inset 3px 3px 6px var(--dark-shadow), inset -3px -3px 6px var(--light-shadow);
            color: var(--dark-shadow); /* Use shadow color to make it look dim */
         }
        /* Explicit text color for active buttons */
        .neumorph-button.active {
            color: var(--accent-color);
        }


        .song-list::-webkit-scrollbar { width: 10px; }
        .song-list::-webkit-scrollbar-track { background: transparent; border-radius: 10px; margin: 5px 0; }
        .song-list::-webkit-scrollbar-thumb { background-color: var(--dark-shadow); border-radius: 10px; border: 2px solid var(--bg-color); }
        .song-list::-webkit-scrollbar-thumb:hover { background-color: var(--light-shadow); } /* Adjust hover color */
         html.dark .song-list::-webkit-scrollbar-thumb:hover { background-color: #4a505f; }


        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 10px;
            background: var(--bg-color); /* Use background color */
            border-radius: 10px; cursor: pointer;
            box-shadow: var(--neumorph-inset-shadow); /* Use inset shadow for track */
             outline: none;
             transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: var(--accent-color);
            border-radius: 50%; cursor: pointer;
            margin-top: -5px; /* Center thumb vertically */
            box-shadow: var(--range-thumb-shadow);
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px;
            background: var(--accent-color);
            border-radius: 50%; cursor: pointer; border: none;
            box-shadow: var(--range-thumb-shadow);
             transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="range"]:active::-webkit-slider-thumb {
             background-color: var(--accent-color-darker);
             box-shadow: var(--range-thumb-shadow-active);
        }
        input[type="range"]:active::-moz-range-thumb {
             background-color: var(--accent-color-darker);
             box-shadow: var(--range-thumb-shadow-active);
        }
        input[type="range"]:disabled::-webkit-slider-thumb { background-color: var(--dark-shadow); box-shadow: none; }
        input[type="range"]:disabled::-moz-range-thumb { background-color: var(--dark-shadow); box-shadow: none; }

        input[type="file"] { display: none; }
        .custom-file-upload { display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }

         /* Icon Sizes */
         .icon { width: 1.25rem; height: 1.25rem; } /* 20px */
         .icon-sm { width: 1rem; height: 1rem; } /* 16px */
         .icon-lg { width: 1.5rem; height: 1.5rem; } /* 24px */
         .icon-xl { width: 2rem; height: 2rem; } /* 32px */
         .control-icon { width: 1.6rem; height: 1.6rem; } /* ~26px */
         .main-control-icon { width: 2rem; height: 2rem; } /* 32px */

         /* Song list active item */
         .song-list-item.active {
            box-shadow: var(--neumorph-inset-shadow); /* Use inset shadow for active */
            color: var(--accent-color);
            font-weight: 600;
         }
          html.dark .song-list-item.active {
             color: var(--accent-color); /* Ensure accent color stands out in dark mode */
          }
         .song-list-item:not(.active):hover {
             background-color: rgba(0,0,0,0.02); /* Subtle hover background */
              box-shadow: inset 2px 2px 5px var(--dark-shadow), inset -2px -2px 5px var(--light-shadow);
         }
         html.dark .song-list-item:not(.active):hover {
             background-color: rgba(255,255,255,0.03);
         }

         /* Vertical Volume Slider Container */
        .volume-control-container {
            display: flex;
            flex-direction: column; /* Stack icon-slider-icon vertically */
            align-items: center;
            gap: 0.75rem; /* Space between icons and slider */
            height: 200px; /* Fixed height for vertical layout */
            width: 60px; /* Width to contain the elements */
            justify-content: center; /* Center items vertically */
        }

        /* Slider Transformation for Vertical */
        .volume-slider-vertical {
            width: 150px; /* This becomes the height */
            height: 10px; /* This becomes the width */
            transform-origin: center center;
            transform: rotate(-90deg); /* Rotate the slider */
            margin: 0; /* Reset margins */
        }
        /* Adjust thumb margin for rotated slider */
        .volume-slider-vertical::-webkit-slider-thumb {
            margin-left: -5px; /* Adjust based on height/2 */
             margin-top: 0;
        }
        /* Container for horizontal layout on small screens */
        .volume-control-container-horizontal {
             display: flex;
             align-items: center;
             gap: 0.75rem;
             width: 100%;
             max-width: 250px;
             height: auto;
        }
        .volume-slider-horizontal {
             flex-grow: 1; /* Take available space */
             transform: none; /* No rotation */
             width: auto; /* Reset width */
             height: 10px; /* Keep thickness */
        }
        .volume-slider-horizontal::-webkit-slider-thumb {
             margin-top: -5px; /* Original centering */
             margin-left: 0;
        }

    </style>
</head>
<body class="transition-colors duration-300 ease-in-out"> 
    <div id="root" class="p-4 sm:p-6 md:p-8"></div>

    <script type="text/babel"> // Important: type="text/babel"

        const { useState, useEffect, useRef, useCallback } = React;
        const { jsmediatags } = window;

        // --- Helper Functions ---
        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }
            return array;
        }


        // --- Main App Component ---
        function App() {
            const [songs, setSongs] = useState([]);
            const [originalSongs, setOriginalSongs] = useState([]);
            const [currentSongIndex, setCurrentSongIndex] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [volume, setVolume] = useState(0.75);
            const [isMetadataLoading, setIsMetadataLoading] = useState(false);
            const [repeatMode, setRepeatMode] = useState('off');
            const [isShuffled, setIsShuffled] = useState(false);
            const [theme, setTheme] = useState(localStorage.getItem('vunoTheme') || 'light'); // Load theme preference

            const audioRef = useRef(null);
            const fileInputRef = useRef(null);

            // --- Theme Management ---
            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('vunoTheme', theme); // Save preference
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
            };

            // --- (Rest of the Effects and Handlers from previous version) ---
            // Load/Save songs metadata from/to local storage
             useEffect(() => { /* ... load logic ... */
                const storedSongsMeta = localStorage.getItem('vunoSongsMeta');
                if (storedSongsMeta) {
                    try {
                        const parsedMeta = JSON.parse(storedSongsMeta);
                        const initialSongs = parsedMeta.map(meta => ({ ...meta, file: null, url: null }));
                        setSongs(initialSongs);
                        setOriginalSongs(initialSongs);
                    } catch (error) { console.error("Failed to parse localStorage:", error); localStorage.removeItem('vunoSongsMeta');}
                }
             }, []);

            useEffect(() => { /* ... save logic ... */
                 if (songs.length > 0 || localStorage.getItem('vunoSongsMeta')) {
                    const songsMeta = songs.map(({ id, name, cover, duration }) => ({ id, name, cover, duration }));
                    try { localStorage.setItem('vunoSongsMeta', JSON.stringify(songsMeta)); }
                    catch (error) { console.error("Failed to save to localStorage:", error); /* Handle quota */ }
                }
            }, [songs]);

            // Play/Pause Effect
            useEffect(() => { /* ... play/pause logic ... */
                 const audio = audioRef.current;
                if (!audio) return;
                if (isPlaying && audio.src && audio.readyState >= 2) {
                     audio.play().catch(error => console.error("Play Error:", error));
                } else { audio.pause(); }
            }, [isPlaying]);

             // Source Change Effect
             useEffect(() => { /* ... source change logic ... */
                const audio = audioRef.current; if (!audio) return;
                const songToPlay = currentSongIndex !== null ? songs[currentSongIndex] : null;
                if (songToPlay && songToPlay.url) {
                    if (audio.src !== songToPlay.url) { // Only change if different
                        audio.src = songToPlay.url; audio.load();
                        setCurrentTime(0); setDuration(songToPlay.duration || 0);
                    }
                     if (isPlaying) {
                         // Rely on canplay or direct play attempt
                         audio.play().catch(e => console.log("Play interrupted:", e));
                     }
                 } else {
                    if(audio.src) { audio.pause(); audio.src = ""; audio.removeAttribute('src'); }
                    setCurrentTime(0); setDuration(0); setIsPlaying(false);
                 }
             }, [currentSongIndex, songs]); // Keep dependencies

             // Volume Effect
             useEffect(() => { /* ... volume logic ... */
                 if (audioRef.current) { audioRef.current.volume = volume; }
             }, [volume]);

             // Object URL Cleanup Effect
             useEffect(() => { /* ... cleanup logic ... */
                 // Consider if cleanup is actually needed or causing issues.
                 // It might be safer to only revoke when explicitly removing a song.
                 // const currentUrls = songs.map(s => s.url).filter(Boolean);
                 // return () => { currentUrls.forEach(url => URL.revokeObjectURL(url)); };
             }, [songs]);

             // --- Event Handlers (Condensed - Assumed mostly unchanged functionally) ---
            const handleFileChange = useCallback((event) => { /* ... file processing logic ... */
                const files = Array.from(event.target.files); if (files.length === 0) return;
                setIsMetadataLoading(true);
                const newSongPromises = files.map(file => new Promise((resolve, reject) => {
                    const songId = Date.now() + Math.random();
                    const initialSongData = { id: songId, name: file.name.replace(/\.[^/.]+$/, ""), file: file, url: null, cover: null, duration: null };
                    jsmediatags.read(file, {
                        onSuccess: tag => { /* ... extract cover ... */
                             let coverUrl = null;
                             if (tag.tags.picture) { try { const { data, format } = tag.tags.picture; let b64 = ""; for (let i = 0; i < data.length; i++) b64 += String.fromCharCode(data[i]); coverUrl = `data:${format};base64,${window.btoa(b64)}`; } catch (e) {console.error("Cover error",e)} }
                             initialSongData.cover = coverUrl;
                             const tempAudio = new Audio(URL.createObjectURL(file)); // Temp URL
                             tempAudio.onloadedmetadata = () => { initialSongData.duration = tempAudio.duration; URL.revokeObjectURL(tempAudio.src); tempAudio.src = ""; resolve(initialSongData); };
                             tempAudio.onerror = (e) => { console.warn(`Duration error ${file.name}`); URL.revokeObjectURL(tempAudio.src); tempAudio.src = ""; resolve(initialSongData); };
                        },
                        onError: error => { /* ... handle tag error, still try duration ... */
                            console.warn(`Tag error: ${file.name}`, error);
                             const tempAudio = new Audio(URL.createObjectURL(file)); // Temp URL
                             tempAudio.onloadedmetadata = () => { initialSongData.duration = tempAudio.duration; URL.revokeObjectURL(tempAudio.src); tempAudio.src = ""; resolve(initialSongData); };
                             tempAudio.onerror = (e) => { console.warn(`Duration error after tag fail ${file.name}`); URL.revokeObjectURL(tempAudio.src); tempAudio.src = ""; resolve(initialSongData); };
                        }
                    });
                }));
                Promise.all(newSongPromises).then(newSongsData => {
                     setSongs(prev => { const combined = [...prev, ...newSongsData]; if (!isShuffled) setOriginalSongs(combined); return combined; });
                     setIsMetadataLoading(false);
                }).catch(error => { console.error("File processing error:", error); setIsMetadataLoading(false); });
                event.target.value = null;
            }, [isShuffled]); // Dependency needed if it affects originalSongs update

             const createAndSetUrlIfNeeded = useCallback((index) => new Promise((resolve, reject) => { /* ... URL creation/check ... */
                if(index < 0 || index >= songs.length) return reject("Invalid index");
                const song = songs[index];
                if (song.url) return resolve(true);
                if (!song.file) { alert(`Missing audio data for "${song.name}". Re-upload needed.`); return reject("Missing file"); }
                const objectURL = URL.createObjectURL(song.file);
                setSongs(prev => {
                    const updated = [...prev];
                    updated[index] = { ...updated[index], url: objectURL };
                    // Update originalSongs too if needed
                    const originalIndex = originalSongs.findIndex(s => s.id === song.id);
                    if (originalIndex > -1) {
                        const newOriginals = [...originalSongs];
                        newOriginals[originalIndex] = { ...newOriginals[originalIndex], url: objectURL };
                        setOriginalSongs(newOriginals);
                    }
                    return updated;
                });
                resolve(true);
             }), [songs, originalSongs]); // Dependencies

             const handlePlayFromList = useCallback(async (index) => { /* ... play from list logic ... */
                if (index === currentSongIndex) { setIsPlaying(p => !p); return; }
                try { await createAndSetUrlIfNeeded(index); setCurrentSongIndex(index); setIsPlaying(true); }
                catch (error) { console.error("Play from list error:", error); }
             }, [currentSongIndex, createAndSetUrlIfNeeded]);

             const handlePlayPause = useCallback(() => { /* ... main play/pause logic ... */
                 if (currentSongIndex === null && songs.length > 0) { handlePlayFromList(0); }
                 else if (currentSongIndex !== null) { setIsPlaying(p => !p); }
             }, [currentSongIndex, songs, handlePlayFromList]);

             const getNextSongIndex = useCallback((currentIndex) => { /* ... get next index (respects repeat/shuffle) ... */
                if (songs.length === 0) return null;
                if (repeatMode === 'one' && !isShuffled) return currentIndex; // Shuffle overrides repeat one logic for *next* track
                if (isShuffled) { if (songs.length <= 1) return 0; let next; do { next = Math.floor(Math.random() * songs.length); } while (next === currentIndex); return next; }
                const next = (currentIndex + 1);
                if (next >= songs.length) return (repeatMode === 'all') ? 0 : null;
                return next;
             }, [songs.length, repeatMode, isShuffled]);

             const getPreviousSongIndex = useCallback((currentIndex) => { /* ... get previous index (respects repeat/shuffle) ... */
                 if (songs.length === 0) return null;
                 if (repeatMode === 'one' && !isShuffled) return currentIndex;
                 if (isShuffled) { if (songs.length <= 1) return 0; let prev; do { prev = Math.floor(Math.random() * songs.length); } while (prev === currentIndex); return prev; }
                 const prev = (currentIndex - 1);
                 if (prev < 0) return (repeatMode === 'all') ? songs.length - 1 : null;
                 return prev;
             }, [songs.length, repeatMode, isShuffled]);

             const playSongAtIndex = useCallback(async (index) => { /* ... prepare and play specific index ... */
                 if (index === null || index < 0 || index >= songs.length) { setIsPlaying(false); if (repeatMode !== 'all') setCurrentSongIndex(null); return; }
                 try { await createAndSetUrlIfNeeded(index); setCurrentSongIndex(index); setIsPlaying(true); }
                 catch (error) { console.error("Play index error:", error); setIsPlaying(false); }
             }, [songs.length, repeatMode, createAndSetUrlIfNeeded]);

             const handleNext = useCallback(() => playSongAtIndex(getNextSongIndex(currentSongIndex ?? -1)), [currentSongIndex, playSongAtIndex, getNextSongIndex]);
             const handlePrev = useCallback(() => { /* ... prev logic (restart if > 3s) ... */
                if (audioRef.current && audioRef.current.currentTime > 3) { audioRef.current.currentTime = 0; setIsPlaying(true); return; }
                playSongAtIndex(getPreviousSongIndex(currentSongIndex ?? 0));
             }, [currentSongIndex, playSongAtIndex, getPreviousSongIndex]);

            const handleTimeUpdate = (e) => setCurrentTime(e.target.currentTime);
            const handleLoadedMetadata = useCallback((e) => { /* ... update duration state and song object ... */
                const newDuration = e.target.duration;
                if (isFinite(newDuration)) {
                     setDuration(newDuration);
                      if (currentSongIndex !== null && songs[currentSongIndex] && songs[currentSongIndex].duration !== newDuration) {
                          setSongs(prevSongs => {
                              const newSongs = [...prevSongs];
                              if (newSongs[currentSongIndex]) { newSongs[currentSongIndex].duration = newDuration; }
                              const originalIndex = originalSongs.findIndex(s => s.id === newSongs[currentSongIndex]?.id);
                              if (originalIndex > -1) {
                                  const newOriginals = [...originalSongs];
                                  newOriginals[originalIndex].duration = newDuration;
                                  setOriginalSongs(newOriginals);
                              }
                              return newSongs;
                          });
                      }
                } else { setDuration(0); }
            }, [currentSongIndex, songs, originalSongs]); // Add originalSongs dependency

             const handleCanPlay = (e) => { if (isPlaying) { e.target.play().catch(err => console.warn("Canplay play failed:", err)); }};
             const handleSongEnd = useCallback(() => { /* ... handle song end (respects repeat/next) ... */
                if (repeatMode === 'one') { audioRef.current.currentTime = 0; audioRef.current.play(); setIsPlaying(true); }
                else { handleNext(); }
             }, [repeatMode, handleNext]);
            const handleProgressChange = (e) => { /* ... seek logic ... */
                 if (audioRef.current && isFinite(duration) && duration > 0) { const newTime = Number(e.target.value); audioRef.current.currentTime = newTime; setCurrentTime(newTime); }
            };
            const handleVolumeChange = (e) => setVolume(parseFloat(e.target.value));
            const handleRepeatToggle = () => setRepeatMode(prev => prev === 'off' ? 'all' : prev === 'all' ? 'one' : 'off');
            const handleShuffleToggle = useCallback(() => { /* ... shuffle logic ... */
                 const currentSongId = currentSongIndex !== null ? songs[currentSongIndex].id : null;
                 setIsShuffled(prev => {
                    const nextState = !prev;
                    if (nextState) {
                        const shuffled = shuffleArray([...originalSongs]);
                        setSongs(shuffled);
                        setCurrentSongIndex(shuffled.findIndex(s => s.id === currentSongId));
                    } else {
                        setSongs(originalSongs);
                        setCurrentSongIndex(originalSongs.findIndex(s => s.id === currentSongId));
                    }
                    return nextState;
                 });
            }, [currentSongIndex, songs, originalSongs]); // Add dependencies
             const handleClearPlaylist = () => { /* ... clear logic ... */
                if (window.confirm("Clear playlist?")) {
                    setIsPlaying(false); setCurrentSongIndex(null);
                    songs.forEach(s => { if(s.url) URL.revokeObjectURL(s.url); }); // Clean up URLs
                    setSongs([]); setOriginalSongs([]);
                    localStorage.removeItem('vunoSongsMeta');
                    if (audioRef.current) { audioRef.current.src = ""; audioRef.current.removeAttribute('src'); }
                }
             };


            // --- Current Song Data ---
            const currentSong = currentSongIndex !== null && songs[currentSongIndex] ? songs[currentSongIndex] : null;
            const hasSongs = songs.length > 0;

            // --- Render ---
            return (
                <div className="min-h-screen flex flex-col items-center p-4 sm:p-8 bg-[var(--bg-color)] text-[var(--text-color)]">
                    {/* Header */}
                    <div className="w-full max-w-7xl flex justify-between items-center mb-6 px-2">
                         <h1 className="text-4xl sm:text-5xl font-bold vuno-title">Vuno</h1>
                          {/* Theme Toggle Button */}
                          <button
                              onClick={toggleTheme}
                              className="neumorph-button p-2.5 rounded-full"
                              title={`Switch to ${theme === 'light' ? 'Dark' : 'Light'} Mode`}
                          >
                              {theme === 'light' ? (
                                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 icon">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                                  </svg>
                              ) : (
                                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 icon">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                                  </svg>
                              )}
                          </button>
                    </div>

                    <div className="w-full max-w-7xl flex flex-col lg:flex-row gap-6 xl:gap-8">

                        {/* Left Sidebar: Upload & Song List */}
                        <div className="neumorph-outset flex-shrink-0 lg:w-3/12 xl:w-1/4 p-5 flex flex-col h-[75vh] md:h-[80vh] lg:h-auto lg:max-h-[calc(100vh-150px)]"> {/* Adjusted height */}
                             <label htmlFor="file-upload" className={`custom-file-upload neumorph-button p-3 text-center mb-5 w-full font-semibold text-base hover:text-[var(--accent-color)] transition-colors ${isMetadataLoading ? 'disabled opacity-70' : ''}`}>
                                 {isMetadataLoading ? (
                                     <svg className="animate-spin h-5 w-5 mr-2 text-[var(--accent-color)]" /* ... spinner svg ... */ >
                                         <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                     </svg>
                                 ) : (
                                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 icon mr-2">
                                         <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                                     </svg>
                                 )}
                                {isMetadataLoading ? 'Processing...' : 'Upload Songs'}
                            </label>
                            <input id="file-upload" ref={fileInputRef} type="file" accept="audio/*,.mp3,.wav,.ogg,.flac" multiple onChange={handleFileChange} disabled={isMetadataLoading}/>
                            <h2 className="text-xl font-semibold mb-3 text-[var(--text-color-light)] px-1">Playlist</h2>
                            <div className="song-list flex-grow overflow-y-auto space-y-2.5 pr-1 relative mb-4"> {/* List */}
                                {/* ... song list mapping ... */}
                                {!hasSongs && <li className="text-[var(--text-color-light)] italic p-2">No songs yet. Upload some music!</li>}
                                {songs.map((song, index) => (
                                    <div key={song.id} onClick={() => handlePlayFromList(index)} /* ... list item jsx ... */
                                        className={`song-list-item p-3 rounded-xl cursor-pointer transition-all duration-200 ease-in-out flex items-center gap-4 relative ${index === currentSongIndex ? 'active' : ''}`}
                                        title={song.url === null && song.file === null ? "Requires re-upload" : `Play ${song.name}`}
                                    >
                                        {index === currentSongIndex && isPlaying && <span className="absolute left-1 top-1/2 -translate-y-1/2 flex h-2 w-2"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-[var(--accent-color)] opacity-75"></span><span className="relative inline-flex rounded-full h-2 w-2 bg-[var(--accent-color-darker)]"></span></span>}
                                        <div className={`flex-shrink-0 w-10 h-10 rounded-lg neumorph-outset p-0.5 overflow-hidden ${index === currentSongIndex ? 'shadow-[2px_2px_4px_var(--dark-shadow),-2px_-2px_4px_var(--light-shadow)]' : ''}`}>
                                            {song.cover ? <img src={song.cover} alt="cover" className="w-full h-full object-cover rounded-[6px]" /> : <div className="w-full h-full rounded-[6px] bg-[var(--bg-color)] flex items-center justify-center text-[var(--text-color-light)] neumorph-inset"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 icon"><path strokeLinecap="round" strokeLinejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5h7.5m0-3.75h.008v.008H12v-.008Z" /></svg> </div>}
                                        </div>
                                        <div className="flex-grow overflow-hidden mr-2">
                                            <p className={`font-medium truncate ${index === currentSongIndex ? 'text-[var(--accent-color)]' : 'text-[var(--text-color)]'}`}>{song.name}</p>
                                            <p className="text-xs text-[var(--text-color-light)]">{formatTime(song.duration)}</p>
                                        </div>
                                        {song.url === null && song.file === null && <span className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-red-500 bg-red-100 px-1.5 py-0.5 rounded dark:bg-red-900 dark:text-red-200" title="File data missing">Reload</span>}
                                    </div>
                                ))}
                            </div>
                            {hasSongs && <button onClick={handleClearPlaylist} /* ... clear button jsx ... */ className="neumorph-button p-2 mt-auto text-sm text-red-600 hover:text-red-800 w-full flex items-center justify-center gap-2"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4 icon"><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg> Clear Playlist </button>}
                        </div>

                        {/* Middle: Player */}
                        <div className="neumorph-outset flex-grow lg:w-6/12 xl:w-2/4 p-6 md:p-8 flex flex-col items-center justify-center neumorph-card-hover min-h-[50vh] lg:min-h-0"> {/* Ensure min height */}
                             {/* Cover Art */}
                             <div className="neumorph-inset w-56 h-56 sm:w-64 sm:h-64 md:w-72 md:h-72 rounded-full mb-8 flex items-center justify-center overflow-hidden p-2">
                                 {currentSong?.cover ? <img src={currentSong.cover} alt="Cover" className="w-full h-full object-cover rounded-full shadow-md" /> : <div className="w-full h-full rounded-full bg-[var(--bg-color)] flex items-center justify-center text-[var(--text-color-light)]"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1} stroke="currentColor" className="w-24 h-24 icon-xl opacity-50"><path strokeLinecap="round" strokeLinejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5h7.5m0-3.75h.008v.008H12v-.008Z" /></svg></div>}
                             </div>
                             {/* Title */}
                             <h3 className="text-xl md:text-2xl font-semibold mb-4 text-center truncate w-full px-4 max-w-md">{currentSong?.name || "No Song Selected"}</h3>
                             {/* Progress Bar */}
                             <div className="w-full max-w-md px-4 mb-6">
                                 <input type="range" min="0" max={duration || 1} value={currentTime} onChange={handleProgressChange} className="w-full cursor-pointer" disabled={!currentSong || !isFinite(duration) || duration <= 0} aria-label="Song progress"/>
                                 <div className="flex justify-between text-xs text-[var(--text-color-light)] mt-2 px-1"><span>{formatTime(currentTime)}</span><span>{formatTime(duration)}</span></div>
                             </div>
                              {/* Main Controls */}
                            <div className="flex items-center space-x-5 md:space-x-7">
                                {/* Previous Button */}
                                <button onClick={handlePrev} className="neumorph-button p-3" disabled={!hasSongs} title="Previous">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 control-icon">
                                      <path strokeLinecap="round" strokeLinejoin="round" d="M21 16.811c0 .864-.933 1.406-1.683.977l-7.108-4.061a1.125 1.125 0 0 1 0-1.954l7.108-4.061A1.125 1.125 0 0 1 21 8.689v8.122ZM11.25 16.811c0 .864-.933 1.406-1.683.977l-7.108-4.061a1.125 1.125 0 0 1 0-1.954l7.108-4.061a1.125 1.125 0 0 1 1.683.977v8.122Z" />
                                    </svg>
                                </button>
                                {/* Play/Pause Button */}
                                <button onClick={handlePlayPause} className={`neumorph-button p-4 rounded-full w-16 h-16 md:w-20 md:h-20 flex items-center justify-center ${isPlaying ? 'active' : ''}`} disabled={!currentSong && !hasSongs} title={isPlaying ? "Pause" : "Play"}>
                                    {isPlaying ? (
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 main-control-icon">
                                          <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                                        </svg>
                                    ) : (
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 main-control-icon">
                                          <path strokeLinecap="round" strokeLinejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347c-.75.412-1.667-.13-1.667-.986V5.653Z" />
                                        </svg>
                                    )}
                                </button>
                                {/* Next Button */}
                                <button onClick={handleNext} className="neumorph-button p-3" disabled={!hasSongs} title="Next">
                                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 control-icon">
                                      <path strokeLinecap="round" strokeLinejoin="round" d="M3 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061A1.125 1.125 0 0 1 3 16.811V8.689ZM12.75 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061a1.125 1.125 0 0 1-1.683-.977V8.689Z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        {/* Right Sidebar: Volume & Options */}
                        <div className="neumorph-outset flex-shrink-0 lg:w-3/12 xl:w-1/4 p-5 flex flex-col items-center justify-between lg:justify-start lg:gap-8 h-[30vh] sm:h-[25vh] lg:h-auto lg:max-h-[calc(100vh-150px)] neumorph-card-hover">
                             {/* Volume Control Section */}
                             <div className='w-full flex flex-col items-center'>
                                <h2 className="text-lg font-semibold mb-3 text-[var(--text-color-light)]">Volume</h2>
                                {/* Responsive Volume Container */}
                                <div className="lg:volume-control-container volume-control-container-horizontal"> {/* Apply appropriate class */}
                                     {/* Volume Down Icon */}
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 icon text-[var(--text-color-light)] flex-shrink-0">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l-2.25 2.25M15 9.75V14.25m-2.25-4.5V14.25m-2.25-4.5V14.25m-2.25-4.5V14.25M6 9.75v4.5M3.75 12h.008v.008H3.75V12Zm0 0H6" />
                                    </svg>
                                    {/* Volume Slider - Apply class based on screen size */}
                                    <input
                                        type="range" min="0" max="1" step="0.01" value={volume} onChange={handleVolumeChange}
                                        className="lg:volume-slider-vertical volume-slider-horizontal" /* Apply appropriate class */
                                        aria-label="Volume control"
                                    />
                                    {/* Volume Up Icon */}
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 icon text-[var(--text-color-light)] flex-shrink-0">
                                      <path strokeLinecap="round" strokeLinejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                                    </svg>
                                </div>
                                <span className="text-xs mt-2 text-[var(--text-color-light)]">{Math.round(volume * 100)}%</span>
                             </div>

                             {/* Additional Controls Section */}
                              <div className='w-full flex flex-col items-center mt-6 lg:mt-0'>
                                 <h2 className="text-lg font-semibold mb-4 text-[var(--text-color-light)]">Options</h2>
                                 <div className="flex justify-center items-center gap-5">
                                     {/* Repeat Button */}
                                     <button onClick={handleRepeatToggle} className={`neumorph-button p-3 ${repeatMode !== 'off' ? 'active' : ''}`} title={`Repeat: ${repeatMode.charAt(0).toUpperCase() + repeatMode.slice(1)}`}>
                                         {repeatMode === 'one' ? (
                                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 control-icon relative">
                                                  <path fillRule="evenodd" d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l.29-1.158a.75.75 0 0 1 1.466.364l-.812 3.247a.75.75 0 0 1-1.06.633l-3.247-.812a.75.75 0 0 1 .364-1.466l1.158.29a5.985 5.985 0 0 0-10.001 2.66 11.15 11.15 0 0 0 .164 1.165A.75.75 0 0 1 5.41 12.78l-.11-.419a.75.75 0 0 1 .187-.897Z" clipRule="evenodd" />
                                                  <path fillRule="evenodd" d="M19.245 13.941a7.5 7.5 0 0 1-12.548 3.364l-.29 1.158a.75.75 0 0 1-1.466-.364l.812-3.247a.75.75 0 0 1 1.06-.633l3.247.812a.75.75 0 0 1-.364 1.466l-1.158-.29a5.985 5.985 0 0 0 10.001-2.66 11.15 11.15 0 0 0-.164-1.165A.75.75 0 0 1 18.59 11.22l.11.419a.75.75 0 0 1-.187.897Z" clipRule="evenodd" />
                                                  {/* Number 1 Overlay */}
                                                  <text x="50%" y="58%" dominantBaseline="middle" textAnchor="middle" fontSize="10" fontWeight="bold" fill="currentColor" className="pointer-events-none">1</text>
                                              </svg>
                                         ) : ( /* Repeat All or Off */
                                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`w-6 h-6 control-icon ${repeatMode === 'off' ? 'opacity-60' : ''}`}>
                                                  <path fillRule="evenodd" d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l.29-1.158a.75.75 0 0 1 1.466.364l-.812 3.247a.75.75 0 0 1-1.06.633l-3.247-.812a.75.75 0 0 1 .364-1.466l1.158.29a5.985 5.985 0 0 0-10.001 2.66 11.15 11.15 0 0 0 .164 1.165A.75.75 0 0 1 5.41 12.78l-.11-.419a.75.75 0 0 1 .187-.897Z" clipRule="evenodd" />
                                                  <path fillRule="evenodd" d="M19.245 13.941a7.5 7.5 0 0 1-12.548 3.364l-.29 1.158a.75.75 0 0 1-1.466-.364l.812-3.247a.75.75 0 0 1 1.06-.633l3.247.812a.75.75 0 0 1-.364 1.466l-1.158-.29a5.985 5.985 0 0 0 10.001-2.66 11.15 11.15 0 0 0-.164-1.165A.75.75 0 0 1 18.59 11.22l.11.419a.75.75 0 0 1-.187.897Z" clipRule="evenodd" />
                                              </svg>
                                         )}
                                     </button>

                                     {/* Shuffle Button */}
                                     <button onClick={handleShuffleToggle} className={`neumorph-button p-3 ${isShuffled ? 'active' : ''}`} disabled={!hasSongs || songs.length < 2} title={`Shuffle: ${isShuffled ? 'On' : 'Off'}`}>
                                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`w-6 h-6 control-icon ${!isShuffled && hasSongs && songs.length >= 2 ? 'opacity-60' : ''}`}>
                                              <path fillRule="evenodd" d="M10.036 2.478c-.636-.196-1.33-.196-1.966 0L.35 6.638a.75.75 0 0 0-.35.65V18a.75.75 0 0 0 .75.75h5.379a.75.75 0 0 0 .53-.22l1.72-1.72a.75.75 0 1 0-1.06-1.06l-1.47 1.47v-4.162a.75.75 0 0 0-.22-.53l-1.72-1.72a.75.75 0 0 0-1.06 1.06l1.47 1.47v5.477a.75.75 0 0 0 1.28.53l15.373-15.373a.75.75 0 0 0-.65-.35H10.5a.75.75 0 0 0-.75.75v3.379a.75.75 0 0 0 1.28.53l1.72-1.72a.75.75 0 1 0-1.06-1.06l-1.47 1.47V5.662a.75.75 0 0 0-.22-.53l-1.72-1.72a.75.75 0 0 0-1.06 1.06l1.47 1.47v5.477a.75.75 0 0 0 1.28.53l3.59-3.59a.75.75 0 0 0 0-1.06L10.037 2.478Z" clipRule="evenodd" />
                                              <path d="M14.28 10.28a.75.75 0 0 0-1.06 0l-1.72 1.72a.75.75 0 1 0 1.06 1.06l1.47-1.47v4.162a.75.75 0 0 0 .22.53l1.72 1.72a.75.75 0 1 0 1.06-1.06l-1.47-1.47V10.5a.75.75 0 0 0-.75-.75h-3.379a.75.75 0 0 0-.53.22Z" />
                                        </svg>
                                     </button>
                                 </div>
                             </div>
                        </div>

                    </div>

                    {/* Hidden Audio Element */}
                    <audio ref={audioRef} onTimeUpdate={handleTimeUpdate} onLoadedMetadata={handleLoadedMetadata} onCanPlay={handleCanPlay} onEnded={handleSongEnd} onError={(e) => console.error("Audio Element Error:", e.target.error)} preload="metadata"></audio>
                </div>
            );
        }

        // --- Mount React App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><App /></React.StrictMode>);

    </script>
</body>
</html>